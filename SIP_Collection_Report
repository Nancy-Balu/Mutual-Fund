create table nancy.collection_report as
with orderdata as
(
select distinct client_code, id,status,amount,Investment_type,user_type,scheme_code,sub_broker_code, created_ts from "dbo_angels"."dbo_wms"."orders" where Investment_type IN('REDEEM','LUMPSUM') and 
upper(status)  in ('ORDER_COMPLETE') and created_ts::date>='2023-07-01'
union all
select distinct client_code,id, status,installment_amount as amount,sip_type as investment_type,user_type,scheme_code,sub_broker_code,created_ts from "dbo_angels"."dbo_wms"."sips" where upper(status) not in ('SIP_REJECTED','SIP_FAILED') and  created_ts::date >= '2023-07-01'   
),
b2b_b2c_Equity as (
select  sum(ord.amount) as amount,ord.investment_type,ord.user_type as channel,sc.taxation_type ,ord.created_ts::date as ddate from 
"dbo_angels"."dbo_wms"."scheme_plan" sc
inner join 
orderdata ord on sc.scheme_code=ord.scheme_code
where upper(sc.taxation_type) IN('EQUITY')
group by 2,3,4,5
),

b2b_b2c_nonequity as (
select  sum(ord.amount) as amount,ord.investment_type,ord.user_type as channel,case when lower(sc.scheme_name) like '%liquid%' then 'Liquid' else 'Debt' end as Scheme_type,ord.created_ts::date as ddate from 
"dbo_angels"."dbo_wms"."scheme_plan" sc
inner join 
orderdata ord on sc.scheme_code=ord.scheme_code
where upper(sc.taxation_type) IN('NON-EQUITY')
group by 2,3,4,5)
,
mfsb_equity as(
    select  sum(ord.amount) as amount,ord.investment_type,'MFSB' as channel,sc.taxation_type ,ord.created_ts::date as ddate from 
"dbo_angels"."dbo_wms"."scheme_plan" sc
inner join 
orderdata ord on sc.scheme_code=ord.scheme_code
where upper(sc.taxation_type) IN('EQUITY') and ord.sub_broker_code='MFSB'
group by 2,3,4,5
),
mfsb_nonequity as(
select  sum(ord.amount) as amount,ord.investment_type,'MFSB' as channel,case when lower(sc.scheme_name) like '%liquid%' then 'Liquid' else 'Debt' end as Scheme_type,ord.created_ts::date as ddate from 
"dbo_angels"."dbo_wms"."scheme_plan" sc
inner join 
orderdata ord on sc.scheme_code=ord.scheme_code
where upper(sc.taxation_type) IN('NON-EQUITY')  and ord.sub_broker_code='MFSB'
group by 2,3,4,5
)


select * from b2b_b2c_Equity
union all 
select * from b2b_b2c_nonequity
union all 
select * from mfsb_equity
union all 
select * from mfsb_nonequity


