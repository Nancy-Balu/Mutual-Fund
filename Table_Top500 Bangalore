By AUM------
select a.client_code,b.city,b.user_type as client_type,COALESCE(c.client_name,d.full_name) as client_name,COALESCE(c.email_id,d.email) as email_id,COALESCE(c.mobile_no,d.mobile) as mobile_no,b.age,a.AUM,a.Dt from (
(
select distinct client_code, sum(CAST(current_value AS DECIMAL(38, 2))) as AUM ,inserted_date::Date as Dt
from dbo_wms_s3.portfolio_holding 
where dt='2023-11-05'
group by 1,3
) a
LEFT JOIN 
( Select distinct party_code,case when b2c='Y' then 'B2C' when b2c='N' then 'B2B' else NULL END as user_type,city,state,nation,region,zone,zip,datediff(year,cast(birthdate as date),current_date) as age from "dbo_angels"."product_analytics"."sn_clientkyc") b
 on a.client_code=b.party_code
LEFT JOIN (
 SELECT distinct party_code,client_name,mobile_no,email_id FROM "dbo_angels_external"."dbo_kycfulfillment"."client_inwardregister"    
)c on a.client_code=c.party_code
LEFT JOIN
(
select distinct a1.user_id,a1.app_number,b1.full_name,c1.email,d1.mobile from dbo_angels."kyc2_fulfillment"."user_id" a1 
 LEFT JOIN
 "dbo_angels"."kyc2_fulfillment"."esign" b1 on a1.app_number=b1.app_number
 LEFT JOIN
 "dbo_angels"."kyc2_fulfillment"."email" c1 on a1.app_number=c1.app_number 
 LEFT JOIN 
 dbo_angels."kyc2_fulfillment"."start" d1 on a1.app_number=d1.app_number
)d on a.client_code=d.user_id
)
where upper(b.city) like '%BANGALORE%' or zip between 560001 and 560114 or zip=560500
order by AUM DESC
LIMIT 500


