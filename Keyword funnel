create table nancy.keyword_funnel as
with clickstream as 
(
select *,(timestamp 'epoch' + client_timestamp_unix/1000 * INTERVAL '1 second') AT TIME ZONE 'UTC' AT TIME ZONE 'Asia/Kolkata'  as cli_timestamp_ist from clickstream.db_dbo_clickstream_data_tablename_mf_clickstream_data where event_id in('300.0.0.1.3','300.0.0.1.2','300.0.0.1.1','300.0.0.1.0','300.0.0.1.3','300.0.0.1.2') and dt>='2023-07-01'
),
raw_data1 as 
(
select distinct client_id as clients,dt,  'Step1' as steps, 'Search_click' as step_name, cli_timestamp_ist,dt from clickstream where event_id in ('300.0.0.1.3','300.0.0.1.2','300.0.0.1.1','300.0.0.1.0') 
union all
select  distinct client_id as clients,dt, 'Step2' as steps, 'Keyword_Search'as step_name,cli_timestamp_ist, dt from  clickstream where   event_id in ('300.0.0.1.3') and client_id in (select  distinct client_id from clickstream  where   event_id in ('300.0.0.1.3','300.0.0.1.2','300.0.0.1.1','300.0.0.1.0'))
union all
select distinct client_id as clients, dt, 'Step3' as steps, 'FundDetails_Clicked' as step_name,cli_timestamp_ist,dt  from clickstream where event_id in ('300.0.0.1.2') and client_id in(select distinct client_id as clients from clickstream where   event_id in ('300.0.0.1.3','300.0.0.1.2','300.0.0.1.1','300.0.0.1.0') and client_id in(select  distinct client_id from clickstream  where event_id in ('300.0.0.1.3') ))
union all
select distinct client_id as clients, dt, 'Step3' as steps, 'FundDetails_NotClicked' as step_name,cli_timestamp_ist,dt  from clickstream where event_id in ('300.0.0.1.3') and client_id not in (select  distinct client_id from clickstream  where event_id in ('300.0.0.1.2') and
client_id in(select distinct client_id as clients from clickstream where   event_id in ('300.0.0.1.3','300.0.0.1.2','300.0.0.1.1','300.0.0.1.0') and client_id in(select  distinct client_id from clickstream  where event_id in ('300.0.0.1.3') ))
))

select count(distinct clients) as clients,step_name
 ,cli_timestamp_ist::date as dtt from raw_Data1 where cli_timestamp_ist::date>='2023-07-01' and cli_timestamp_ist::date<current_date
group by 2,3
